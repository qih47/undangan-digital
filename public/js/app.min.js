$(function () {
  // Fungsi untuk mengatur tipe sidebar berdasarkan lebar jendela
  var setsidebartype = function () {
    var width = window.innerWidth > 0 ? window.innerWidth : screen.width;
    if (width < 1199) {
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").addClass("mini-sidebar");
    } else {
      $("#main-wrapper").attr("data-sidebartype", "full");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  };

  $(window).ready(setsidebartype);
  $(window).on("resize", setsidebartype);

  $(".sidebartoggler").on("click", function () {
    var $mainWrapper = $("#main-wrapper");
    var sidebarType = $mainWrapper.attr("data-sidebartype");

    if (sidebarType === "mini-sidebar") {
      $mainWrapper.toggleClass("show-sidebar");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "full");
    } else {
      $mainWrapper.toggleClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  });
});

$(document).ready(function () {
  var table = $("#tabel_list_undangan").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/listundangan",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1; // placeholder, akan ditimpa di bawah
        },
      },
      { data: "nama" },
      { data: "partner" },
      { data: "kota" },
      { data: "status" },
      { data: "link" },
      {
        data: "qrcode",
        render: function (data, type, row) {
          return `<img src="/qrcode/${data}" width="80" />`;
        },
      },
      { data: "id", visible: false }, // untuk sorting
    ],
    order: [[6, "desc"]], // urut berdasarkan id DESC (data terbaru di atas)
  });

  // Fix nomor urut (#) biar tetap dari 1 ke bawah
  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Input undangan
$("#submit").css("cursor", "pointer");

$(document).on("click", "#submit", function (event) {
  event.preventDefault();

  var csrfName = $("#csrf_token").attr("name");
  var csrfHash = $("#csrf_token").val();
  var nama = $("#nama").val();
  var partner = $("#partner").val();
  var gender = $("#gender").val();
  var kota = $("#kota").val();
  var status = $("#status").val();

  $.ajax({
    type: "POST",
    url: "/invitation/simpan",
    data: {
      nama: nama,
      partner: partner,
      gender: gender,
      kota: kota,
      status: status,
      [csrfName]: csrfHash,
    },
    success: function (data) {
      if (data === "error") {
        inputGagal();
      } else {
        // Kosongkan input
        $("#nama").val("");
        $("#partner").val("");
        $("#kota").val("");

        // Reset dropdown ke default (misal option value="" -> "Pilih")
        $("#gender").val("");
        $("#status").val("");

        // Reload datatables
        $("#tabel_list_undangan").DataTable().ajax.reload(null, false);
        inputOk();
      }
    },
  });
});

// sweetalert validasi koreksi ok
function inputOk() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "success",
    title: "Berhasil Menyimpan data undangan!!",
  });
}

// sweetalert validasi koreksi gagal
function inputGagal() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "error",
    title: "Gagal menyimpan data undangan!!",
  });
}


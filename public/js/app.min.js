$(function () {
  // Fungsi untuk mengatur tipe sidebar berdasarkan lebar jendela
  var setsidebartype = function () {
    var width = window.innerWidth > 0 ? window.innerWidth : screen.width;
    if (width < 1199) {
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").addClass("mini-sidebar");
    } else {
      $("#main-wrapper").attr("data-sidebartype", "full");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  };

  $(window).ready(setsidebartype);
  $(window).on("resize", setsidebartype);

  $(".sidebartoggler").on("click", function () {
    var $mainWrapper = $("#main-wrapper");
    var sidebarType = $mainWrapper.attr("data-sidebartype");

    if (sidebarType === "mini-sidebar") {
      $mainWrapper.toggleClass("show-sidebar");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "full");
    } else {
      $mainWrapper.toggleClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  });
});

// Tabel List Tamu
$(document).ready(function () {
  var table = $("#tabel_list_undangan").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/listundangan",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      { data: "nama" },
      { data: "partner" },
      { data: "kota" },
      { data: "status" },
      {
        data: "link",
        render: function (data, type, row) {
          if (type === "display" && data) {
            return `<a href="${data}" target="_blank">${data}</a>`;
          }
          return data;
        },
      },
      {
        data: "qrcode",
        render: function (data, type, row) {
          return `<img src="/qrcode/${data}" width="80" />`;
        },
      },
      { data: "id", visible: false },
    ],
    order: [[6, "desc"]],
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Tabel Daftar Hadir
$(document).ready(function () {
  var table = $("#tabel_daftar_hadir").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/daftarhadir",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return row.nama + ", " + row.partner;
        },
      },
      { data: "jumlah" },
      { data: "kota" },
      { data: "created_at" },
    ],
    order: [[5, "desc"]],
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Tabel Buku Tamu
$(document).ready(function () {
  var table = $("#tabel_buku_tamu").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/buku",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return row.nama + ", " + row.partner;
        },
      },
      { data: "jumlah" },
      { data: "kota" },
      { data: "jenis" },
      { data: "created_at" },
      {
        data: "link",
        render: function (data, type, row) {
          if (type === "display" && data) {
            return `<a href="${data}" target="_blank">${data}</a>`;
          }
          return data;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return `
      <button class="btn btn-sm btn-primary btn-lihat-doa" data-doa="">
        <i class="fas fa-comment"></i>
      </button>
    `;
        },
      },
      {
        data: "qrcode",
        render: function (data, type, row) {
          return `<img src="/qrcode/${data}" width="80" />`;
        },
      },
    ],
    order: [[5, "desc"]],
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

$(document).on("click", ".btn-lihat-doa", function () {
  var doa = $(this).data("doa");
  $("#isiDoa").text(doa || "Belum ada doa.");
  $("#modalDoa").modal("show");
});

// Input undangan
$("#submit").css("cursor", "pointer");

$(document).on("click", "#submit", function (event) {
  event.preventDefault();

  var csrfName = $("#csrf_token").attr("name");
  var csrfHash = $("#csrf_token").val();
  var nama = $("#nama").val();
  var partner = $("#partner").val();
  // var gender = $("#gender").val();
  var kota = $("#kota").val();
  var status = $("#status").val();

  $.ajax({
    type: "POST",
    url: "/invitation/simpan",
    data: {
      nama: nama,
      partner: partner,
      // gender: gender,
      kota: kota,
      status: status,
      [csrfName]: csrfHash,
    },
    success: function (data) {
      if (data === "error") {
        inputGagal();
      } else {
        $("#nama").val("");
        $("#partner").val("");
        $("#kota").val("");
        $("#gender").val("Pilih");
        $("#status").val("Pilih");

        $("#tabel_list_undangan").DataTable().ajax.reload(null, false);
        inputOk();
      }
    },
  });
});

function inputOk() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "success",
    title: "Berhasil Menyimpan data undangan!!",
  });
}

function inputGagal() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "error",
    title: "Gagal menyimpan data undangan!!",
  });
}

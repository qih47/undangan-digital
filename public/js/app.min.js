$(function () {
  // Fungsi untuk mengatur tipe sidebar berdasarkan lebar jendela
  var setsidebartype = function () {
    var width = window.innerWidth > 0 ? window.innerWidth : screen.width;
    if (width < 1199) {
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").addClass("mini-sidebar");
    } else {
      $("#main-wrapper").attr("data-sidebartype", "full");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  };

  $(window).ready(setsidebartype);
  $(window).on("resize", setsidebartype);

  $(".sidebartoggler").on("click", function () {
    var $mainWrapper = $("#main-wrapper");
    var sidebarType = $mainWrapper.attr("data-sidebartype");

    if (sidebarType === "mini-sidebar") {
      $mainWrapper.toggleClass("show-sidebar");
      $("#main-wrapper").removeClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "full");
    } else {
      $mainWrapper.toggleClass("mini-sidebar");
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").removeClass("show-sidebar");
    }
  });
});

// Tabel List Tamu
$(document).ready(function () {
  var table = $("#tabel_list_undangan").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/listundangan",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      { data: "nama" },
      { data: "partner" },
      { data: "kota" },
      { data: "status" },
      {
        data: "link",
        render: function (data, type, row) {
          if (type === "display" && data) {
            return `<a href="${data}" target="_blank">${data}</a>`;
          }
          return data;
        },
      },
      {
        data: "qrcode",
        render: function (data, type, row) {
          return `<img src="/qrcode/${data}" width="80" />`;
        },
      },
      { data: "id", visible: false },
    ],
    order: [[6, "desc"]],
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Tabel Daftar Hadir
$(document).ready(function () {
  var table = $("#tabel_daftar_hadir").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/daftarhadir",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return row.nama + ", " + row.partner;
        },
      },
      { data: "jumlah" },
      { data: "kota" },
      { data: "created_at" },
    ],
    order: [[5, "desc"]],
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Tabel Buku Tamu
$(document).ready(function () {
  var table = $("#tabel_buku_tamu").DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "/invitation/buku",
      dataSrc: "data",
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return row.nama + ", " + row.partner;
        },
      },
      { data: "jumlah" },
      { data: "kota" },
      { data: "jenis" },
      { data: "created_at" },
      {
        data: "link",
        render: function (data, type, row) {
          if (type === "display" && data) {
            return `<a href="${data}" target="_blank">${data}</a>`;
          }
          return data;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          let nama;
                    if (row.partner === "") {
            nama = row.nama;
          } else {
            nama = row.nama+' & '+row.partner;
          }
          const ucapanList = (row.ucapan || "Belum ada ucapan").split("\n");
          const content = ucapanList
            .map(
              (ucapan) =>
                `<div class="d-flex align-items-start mb-1">
                  ${ucapan}</span>
                </div>`
            )
            .join("");

          return `
            <a tabindex="0" class="btn bg-danger-subtle d-inline-flex align-items-center text-success"
               role="button"
               data-bs-toggle="popover"
               data-bs-html="true"
               data-bs-trigger="focus"
               title="Doa dari ${nama}"
               data-bs-content='${content}'>
              <i class="fas fa-comment me-2 fs-4"></i>
            </a>
          `;
        },
      },
      {
        data: "qrcode",
        render: function (data, type, row) {
          return `<img src="/qrcode/${data}" width="80" />`;
        },
      },
    ],
    order: [[5, "desc"]],
    drawCallback: function () {
      $('[data-bs-toggle="popover"]').each(function () {
        new bootstrap.Popover(this, {
          html: true,
          trigger: "hover focus",
          placement: "auto",
        });
      });
    },
  });

  table.on("order.dt search.dt draw.dt", function () {
    let info = table.page.info();
    table
      .column(0, { search: "applied", order: "applied" })
      .nodes()
      .each(function (cell, i) {
        cell.innerHTML = i + 1 + info.start;
      });
  });
});

// Input undangan
$("#submit").css("cursor", "pointer");

$(document).on("click", "#submit", function (event) {
  event.preventDefault();

  var csrfName = $("#csrf_token").attr("name");
  var csrfHash = $("#csrf_token").val();
  var nama = $("#nama").val();
  var partner = $("#partner").val();
  // var gender = $("#gender").val();
  var kota = $("#kota").val();
  var status = $("#status").val();

  $.ajax({
    type: "POST",
    url: "/invitation/simpan",
    data: {
      nama: nama,
      partner: partner,
      // gender: gender,
      kota: kota,
      status: status,
      [csrfName]: csrfHash,
    },
    success: function (data) {
      if (data === "error") {
        inputGagal();
      } else {
        $("#nama").val("");
        $("#partner").val("");
        $("#kota").val("");
        $("#gender").val("Pilih");
        $("#status").val("Pilih");

        $("#tabel_list_undangan").DataTable().ajax.reload(null, false);
        inputOk();
      }
    },
  });
});

function inputOk() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "success",
    title: "Berhasil Menyimpan data undangan!!",
  });
}

function inputGagal() {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener("mouseenter", Swal.stopTimer);
      toast.addEventListener("mouseleave", Swal.resumeTimer);
    },
  });

  Toast.fire({
    icon: "error",
    title: "Gagal menyimpan data undangan!!",
  });
}

function waktuRelatif(datetime) {
  const waktu = new Date(datetime);
  const sekarang = new Date();

  const diffMs = sekarang - waktu;
  const diffSeconds = Math.floor(diffMs / 1000);
  const diffMinutes = Math.floor(diffSeconds / 60);
  const diffHours = Math.floor(diffMinutes / 60);
  const diffDays = Math.floor(diffHours / 24);
  const diffMonths = Math.floor(diffDays / 30);
  const diffYears = Math.floor(diffDays / 365);

  if (diffYears > 0) {
    return `${diffYears} tahun`;
  } else if (diffMonths > 0) {
    return `${diffMonths} bulan`;
  } else if (diffDays > 0) {
    return `${diffDays} hari`;
  } else if (diffHours > 0) {
    return `${diffHours} jam`;
  } else if (diffMinutes > 0) {
    return `${diffMinutes} menit`;
  } else {
    return "Baru saja";
  }
}


function loadUcapan() {
  $.getJSON("/ucapan/list", function (data) {
    let html = "";
    data.forEach((chat) => {
      const waktu = waktuRelatif(chat.time_created);
      html += `
        <li>
          <a href="javascript:void(0)" class="px-3 py-2 bg-hover-light-black d-flex align-items-start justify-content-between chat-user" id="chat_user_${chat.id}" data-user-id="${chat.id}">
            <div class="d-flex align-items-center">
              <span class="position-relative">
                <img src="/images/profile/profile.png" alt="${chat.nama}" width="36" height="36" class="rounded-circle" />
                <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-${chat.kota}">
                  <span class="visually-hidden">Status</span>
                </span>
              </span>
              <div class="ms-2 d-inline-block w-75">
                <h1 class="mb-1 fw-semibold chat-title" style="font-size: 9pt;" data-username="${chat.pengirim}">
                  ${chat.pengirim}
                </h1>
                <span class="fs-2 text-body-color d-block text-wrap text-justify">${chat.ucapan}</span>
              </div>
            </div>
            <p class="fs-1 mb-0 text-muted text-nowrap">${waktu}</p>
          </a>
        </li>
      `;
    });

    $("#chat-list").html(html); // Ganti `#chat-list` dengan ID <ul> tempat data ditaruh
  });
}

// Panggil setiap 5 detik
setInterval(loadUcapan, 5000);

// Load pertama saat halaman dibuka
loadUcapan();

